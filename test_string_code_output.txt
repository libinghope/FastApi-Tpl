============================= test session starts ==============================
platform darwin -- Python 3.10.15, pytest-9.0.2, pluggy-1.6.0 -- /usr/local/opt/python@3.10/bin/python3.10
cachedir: .pytest_cache
rootdir: /Users/bing/workspace/Tpl/FastApi-Tpl
configfile: pytest.ini
plugins: mock-3.15.1, anyio-4.12.0, asyncio-1.3.0, cov-7.0.0
asyncio: mode=auto, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 9 items

tests/api/v1/admin/sys/test_user.py::test_get_users_list PASSED          [ 11%]
tests/api/v1/admin/sys/test_user.py::test_add_user FAILED                [ 22%]
tests/api/v1/admin/sys/test_user.py::test_add_user_duplicate PASSED      [ 33%]
tests/api/v1/admin/sys/test_user.py::test_update_user PASSED             [ 44%]
tests/api/v1/admin/sys/test_user.py::test_update_user_not_found PASSED   [ 55%]
tests/api/v1/admin/sys/test_user.py::test_delete_user PASSED             [ 66%]
tests/api/v1/admin/sys/test_user.py::test_delete_self PASSED             [ 77%]
tests/api/v1/admin/sys/test_user.py::test_change_active_status PASSED    [ 88%]
tests/api/v1/admin/sys/test_user.py::test_reset_password PASSED          [100%]

=================================== FAILURES ===================================
________________________________ test_add_user _________________________________

client = <httpx.AsyncClient object at 0x109e7ed70>, override_deps = None
mock_db_session = <AsyncMock id='4461162752'>

    @pytest.mark.anyio
    async def test_add_user(client, override_deps, mock_db_session):
        """
        测试添加用户接口
    
        测试管理员添加新用户的功能，验证接口是否能够正确处理用户创建请求，
        并返回成功响应。模拟了用户名唯一性检查通过的场景。
    
        Args:
            client: FastAPI测试客户端
            override_deps: 覆盖依赖项的夹具
            mock_db_session: 模拟的数据库会话
        """
        # 准备添加用户的请求参数
        payload = {
            "username": "newuser",  # 新用户名
            "nickname": "New User",  # 用户昵称
            "password": "pass123",  # 用户密码（限制在72字节以内）
            "role_ids": [1],  # 用户角色ID列表
        }
    
        # 模拟用户名唯一性检查，返回None表示用户名可用
        mock_db_session.scalar.return_value = None
    
        # 发送添加用户的POST请求
        response = await client.post("/api/v1/admin/sys/user/add", json=payload)
    
        # 调试信息：如果请求失败，打印响应内容
        if response.status_code != 200:
            print(response.json())
    
        # 验证响应结果
        assert response.status_code == 200  # 验证HTTP状态码为200
>       assert response.json()["code"] == 200  # 验证业务状态码为200
E       AssertionError: assert 'SUCCESS' == 200

tests/api/v1/admin/sys/test_user.py:201: AssertionError
=========================== short test summary info ============================
FAILED tests/api/v1/admin/sys/test_user.py::test_add_user - AssertionError: a...
========================= 1 failed, 8 passed in 0.87s ==========================
